<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps API å•é¡Œè¨ºæ–·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .status-card {
            margin: 15px 0;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid;
        }
        .success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
        #map, #streetview {
            height: 400px;
            width: 100%;
            margin: 15px 0;
            border: 2px solid #dee2e6;
            border-radius: 8px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
            transition: background 0.3s;
        }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .log-console {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 250px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.4;
        }
        .api-key-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin: 15px 0;
            font-family: monospace;
            word-break: break-all;
        }
        .solution-box {
            background: #e7f3ff;
            border: 2px solid #0066cc;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Google Maps API å®Œæ•´è¨ºæ–·å·¥å…·</h1>
        <p>æ­£åœ¨æª¢æ¸¬ä½ çš„APIé…ç½®å•é¡Œ...</p>

        <div class="api-key-display">
            <strong>ä½¿ç”¨çš„APIé‡‘é‘°:</strong> AIzaSyCkb3gNyldoHpt7IwyduZtXQ2Br1K0ooc0
        </div>

        <div id="step1" class="status-card warning">
            â³ æ­¥é©Ÿ 1: æª¢æŸ¥ç¶²è·¯é€£ç·š...
        </div>

        <div id="step2" class="status-card warning">
            â³ æ­¥é©Ÿ 2: æª¢æŸ¥APIè¼‰å…¥...
        </div>

        <div id="step3" class="status-card warning">
            â³ æ­¥é©Ÿ 3: æª¢æŸ¥APIæœå‹™...
        </div>

        <div class="status-card info">
            <h3>ğŸ›ï¸ æ§åˆ¶å°</h3>
            <div id="console-log" class="log-console">è¨ºæ–·é–‹å§‹...\n</div>
            <button class="btn" onclick="clearConsole()">æ¸…é™¤æ—¥èªŒ</button>
            <button class="btn btn-success" onclick="runFullDiagnosis()">é‡æ–°è¨ºæ–·</button>
        </div>

        <div id="test-controls" style="display: none;">
            <button class="btn" onclick="testMap()">æ¸¬è©¦åœ°åœ–</button>
            <button class="btn" onclick="testStreetView()">æ¸¬è©¦è¡—æ™¯</button>
            <button class="btn" onclick="testGeometry()">æ¸¬è©¦å¹¾ä½•</button>
        </div>

        <div id="map-section" style="display: none;">
            <h3>ğŸ—ºï¸ åœ°åœ–æ¸¬è©¦</h3>
            <div id="map"></div>
        </div>

        <div id="streetview-section" style="display: none;">
            <h3>ğŸ“· è¡—æ™¯æ¸¬è©¦</h3>
            <div id="streetview"></div>
        </div>

        <div id="solution" style="display: none;">
            <div class="solution-box">
                <h3>ğŸ› ï¸ è§£æ±ºæ–¹æ¡ˆ</h3>
                <div id="solution-content"></div>
            </div>
        </div>
    </div>

    <script>
        let logConsole = document.getElementById('console-log');
        let currentStep = 1;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#3498db',
                'success': '#2ecc71',
                'error': '#e74c3c',
                'warning': '#f39c12'
            };

            logConsole.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span>\n`;
            logConsole.scrollTop = logConsole.scrollHeight;
            console.log(message);
        }

        function updateStep(stepNum, message, type) {
            const stepElement = document.getElementById(`step${stepNum}`);
            stepElement.className = `status-card ${type}`;
            stepElement.innerHTML = message;
        }

        function clearConsole() {
            logConsole.innerHTML = 'æ—¥èªŒå·²æ¸…é™¤...\n';
        }

        // æ­¥é©Ÿ1ï¼šæª¢æŸ¥ç¶²è·¯
        function checkNetwork() {
            log('ğŸ“¡ æª¢æŸ¥ç¶²è·¯é€£ç·š...', 'info');
            if (navigator.onLine) {
                updateStep(1, 'âœ… æ­¥é©Ÿ 1: ç¶²è·¯é€£ç·šæ­£å¸¸', 'success');
                log('âœ… ç¶²è·¯é€£ç·šæ­£å¸¸', 'success');
                checkApiLoad();
            } else {
                updateStep(1, 'âŒ æ­¥é©Ÿ 1: ç¶²è·¯é€£ç·šå¤±æ•—', 'error');
                log('âŒ ç¶²è·¯é€£ç·šå¤±æ•—', 'error');
                showSolution('ç¶²è·¯é€£ç·šå•é¡Œ');
            }
        }

        // æ­¥é©Ÿ2ï¼šæª¢æŸ¥APIè¼‰å…¥
        function checkApiLoad() {
            log('ğŸ” æª¢æŸ¥Google Maps APIè¼‰å…¥...', 'info');

            if (typeof google !== 'undefined' && google.maps) {
                updateStep(2, 'âœ… æ­¥é©Ÿ 2: Google Maps API è¼‰å…¥æˆåŠŸ', 'success');
                log('âœ… Google Maps API è¼‰å…¥æˆåŠŸ', 'success');
                checkApiServices();
            } else {
                updateStep(2, 'âŒ æ­¥é©Ÿ 2: Google Maps API è¼‰å…¥å¤±æ•—', 'error');
                log('âŒ Google Maps API è¼‰å…¥å¤±æ•—', 'error');
                showSolution('APIè¼‰å…¥å¤±æ•—');
            }
        }

        // æ­¥é©Ÿ3ï¼šæª¢æŸ¥APIæœå‹™
        function checkApiServices() {
            log('ğŸ”§ æª¢æŸ¥APIæœå‹™...', 'info');

            try {
                // æ¸¬è©¦åŸºæœ¬åœ°åœ–
                const testMap = new google.maps.Map(document.createElement('div'), {
                    center: { lat: 0, lng: 0 },
                    zoom: 1
                });
                log('âœ… åœ°åœ–æœå‹™å¯ç”¨', 'success');

                // æ¸¬è©¦è¡—æ™¯
                const testStreetView = new google.maps.StreetViewPanorama(
                    document.createElement('div'),
                    { position: { lat: 35.6762, lng: 139.6503 } }
                );
                log('âœ… è¡—æ™¯æœå‹™å¯ç”¨', 'success');

                // æ¸¬è©¦å¹¾ä½•è¨ˆç®—
                if (google.maps.geometry && google.maps.geometry.spherical) {
                    log('âœ… å¹¾ä½•æœå‹™å¯ç”¨', 'success');
                    updateStep(3, 'âœ… æ­¥é©Ÿ 3: æ‰€æœ‰APIæœå‹™æ­£å¸¸', 'success');
                    showTestControls();
                } else {
                    throw new Error('å¹¾ä½•åº«æœªè¼‰å…¥');
                }

            } catch (error) {
                updateStep(3, 'âŒ æ­¥é©Ÿ 3: APIæœå‹™éŒ¯èª¤', 'error');
                log(`âŒ APIæœå‹™éŒ¯èª¤: ${error.message}`, 'error');

                if (error.message.includes('ApiNotActivatedMapError')) {
                    showSolution('ApiNotActivatedMapError');
                } else {
                    showSolution('å…¶ä»–APIéŒ¯èª¤');
                }
            }
        }

        function showTestControls() {
            document.getElementById('test-controls').style.display = 'block';
            log('ğŸ® è¨ºæ–·å®Œæˆï¼Œå¯ä»¥é–‹å§‹è©³ç´°æ¸¬è©¦', 'success');
        }

        function testMap() {
            log('ğŸ—ºï¸ æ¸¬è©¦åœ°åœ–åŠŸèƒ½...', 'info');
            document.getElementById('map-section').style.display = 'block';

            const map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 25.0330, lng: 121.5654 },
                zoom: 12
            });

            const marker = new google.maps.Marker({
                position: { lat: 25.0330, lng: 121.5654 },
                map: map,
                title: 'å°åŒ—101'
            });

            log('âœ… åœ°åœ–å’Œæ¨™è¨˜é¡¯ç¤ºæˆåŠŸ', 'success');
        }

        function testStreetView() {
            log('ğŸ“· æ¸¬è©¦è¡—æ™¯åŠŸèƒ½...', 'info');
            document.getElementById('streetview-section').style.display = 'block';

            const streetView = new google.maps.StreetViewPanorama(
                document.getElementById('streetview'),
                {
                    position: { lat: 25.0330, lng: 121.5654 },
                    pov: { heading: 165, pitch: 0 },
                    zoom: 1
                }
            );

            log('âœ… è¡—æ™¯é¡¯ç¤ºæˆåŠŸ', 'success');
        }

        function testGeometry() {
            log('ğŸ“ æ¸¬è©¦å¹¾ä½•è¨ˆç®—...', 'info');

            const taipei = new google.maps.LatLng(25.0330, 121.5654);
            const tokyo = new google.maps.LatLng(35.6762, 139.6503);

            const distance = google.maps.geometry.spherical.computeDistanceBetween(taipei, tokyo);
            const distanceKm = Math.round(distance / 1000);

            log(`âœ… è·é›¢è¨ˆç®—æˆåŠŸ: å°åŒ—åˆ°æ±äº¬ ${distanceKm}å…¬é‡Œ`, 'success');
        }

        function showSolution(problemType) {
            const solutionDiv = document.getElementById('solution');
            const contentDiv = document.getElementById('solution-content');

            let content = '';

            switch (problemType) {
                case 'ApiNotActivatedMapError':
                    content = `
                        <h4>âŒ ApiNotActivatedMapError è§£æ±ºæ–¹æ¡ˆ</h4>
                        <p><strong>å•é¡Œ:</strong> Maps JavaScript API æœªå•Ÿç”¨</p>
                        <ol>
                            <li>å‰å¾€ <a href="https://console.cloud.google.com/apis/library/maps-backend.googleapis.com" target="_blank">Google Cloud Console - Maps JavaScript API</a></li>
                            <li>é¸æ“‡ä½ çš„å°ˆæ¡ˆ</li>
                            <li>é»æ“Šã€Œå•Ÿç”¨ã€æŒ‰éˆ•</li>
                            <li>ç­‰å¾…å•Ÿç”¨å®Œæˆï¼ˆå¯èƒ½éœ€è¦å¹¾åˆ†é˜ï¼‰</li>
                        </ol>
                        <p><strong>åŒæ™‚ä¹Ÿè¦å•Ÿç”¨:</strong></p>
                        <ul>
                            <li><a href="https://console.cloud.google.com/apis/library/street-view-image-backend.googleapis.com" target="_blank">Street View Static API</a></li>
                            <li><a href="https://console.cloud.google.com/apis/library/geocoding-backend.googleapis.com" target="_blank">Geocoding API</a> (å¯é¸)</li>
                        </ul>
                    `;
                    break;
                case 'APIè¼‰å…¥å¤±æ•—':
                    content = `
                        <h4>âŒ API è¼‰å…¥å¤±æ•—è§£æ±ºæ–¹æ¡ˆ</h4>
                        <ol>
                            <li>æª¢æŸ¥APIé‡‘é‘°æ˜¯å¦æ­£ç¢º</li>
                            <li>æª¢æŸ¥ç¶²è·¯é€£ç·š</li>
                            <li>ç¢ºèªç€è¦½å™¨æ²’æœ‰é˜»æ“‹JavaScript</li>
                            <li>å˜—è©¦é‡æ–°è¼‰å…¥é é¢</li>
                        </ol>
                    `;
                    break;
                default:
                    content = `
                        <h4>âŒ ä¸€èˆ¬è§£æ±ºæ–¹æ¡ˆ</h4>
                        <ol>
                            <li>æª¢æŸ¥ Google Cloud Console è¨ˆè²»æ˜¯å¦å·²å•Ÿç”¨</li>
                            <li>ç¢ºèª API é‡‘é‘°æ²’æœ‰ IP æˆ–åŸŸåé™åˆ¶</li>
                            <li>æª¢æŸ¥ API é…é¡æ˜¯å¦å·²ç”¨å®Œ</li>
                            <li>ç¢ºèªå°ˆæ¡ˆæœ‰è¶³å¤ çš„ä¿¡ç”¨é¡åº¦</li>
                        </ol>
                    `;
            }

            contentDiv.innerHTML = content;
            solutionDiv.style.display = 'block';
        }

        function runFullDiagnosis() {
            log('ğŸ”„ é‡æ–°é–‹å§‹å®Œæ•´è¨ºæ–·...', 'info');
            clearConsole();

            // é‡è¨­æ‰€æœ‰æ­¥é©Ÿ
            updateStep(1, 'â³ æ­¥é©Ÿ 1: æª¢æŸ¥ç¶²è·¯é€£ç·š...', 'warning');
            updateStep(2, 'â³ æ­¥é©Ÿ 2: æª¢æŸ¥APIè¼‰å…¥...', 'warning');
            updateStep(3, 'â³ æ­¥é©Ÿ 3: æª¢æŸ¥APIæœå‹™...', 'warning');

            document.getElementById('solution').style.display = 'none';

            setTimeout(checkNetwork, 1000);
        }

        // APIéŒ¯èª¤è™•ç†
        window.gm_authFailure = function() {
            updateStep(2, 'âŒ æ­¥é©Ÿ 2: API èªè­‰å¤±æ•—', 'error');
            log('âŒ Google Maps API èªè­‰å¤±æ•—', 'error');
            showSolution('ApiNotActivatedMapError');
        };

        // é é¢è¼‰å…¥å¾Œè‡ªå‹•é–‹å§‹è¨ºæ–·
        window.addEventListener('load', function() {
            setTimeout(runFullDiagnosis, 500);
        });
    </script>

    <!-- Google Maps API è¼‰å…¥ -->
    <script>
        function initDiagnosis() {
            log('ğŸš€ Google Maps API è¼‰å…¥å®Œæˆï¼Œé–‹å§‹æª¢æŸ¥...', 'success');
            checkApiLoad();
        }
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkb3gNyldoHpt7IwyduZtXQ2Br1K0ooc0&libraries=geometry&callback=initDiagnosis">
    </script>
</body>
</html>
