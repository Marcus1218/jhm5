<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>簡單 API 測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        #map {
            height: 300px;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Google Maps API 簡單測試</h1>

        <div id="step1" class="status warning">步驟 1: 檢查網路連線...</div>
        <div id="step2" class="status warning">步驟 2: 載入 Google Maps API...</div>
        <div id="step3" class="status warning">步驟 3: 測試地圖初始化...</div>

        <div id="error-details" style="display: none;">
            <h3>🚨 錯誤詳情</h3>
            <div id="error-content"></div>
        </div>

        <div id="success-details" style="display: none;">
            <h3>✅ 成功！</h3>
            <p>Google Maps API 工作正常</p>
            <div id="map"></div>
        </div>

        <div id="instructions">
            <h3>📋 API 設定檢查清單</h3>
            <p>如果測試失敗，請確認以下設定：</p>
            <ol>
                <li><strong>API 金鑰正確性</strong>: AIzaSyCkb3gNyldoHpt7IwyduZtXQ2Br1K0ooc0</li>
                <li><strong>已啟用的 API</strong>:
                    <ul>
                        <li>Maps JavaScript API</li>
                        <li>Street View Static API</li>
                    </ul>
                </li>
                <li><strong>HTTP 引薦者限制</strong>:
                    <ul>
                        <li>http://localhost:8000/*</li>
                        <li>http://127.0.0.1:8000/*</li>
                    </ul>
                </li>
            </ol>

            <p><a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="background: #007bff; color: white; padding: 10px 15px; text-decoration: none; border-radius: 5px;">🔧 前往 Google Cloud Console</a></p>
        </div>
    </div>

    <script>
        let testStartTime = Date.now();

        function updateStep(stepId, message, type) {
            const element = document.getElementById(stepId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function showError(details) {
            document.getElementById('error-details').style.display = 'block';
            document.getElementById('error-content').innerHTML = details;
        }

        function showSuccess() {
            document.getElementById('success-details').style.display = 'block';
        }

        // 步驟 1: 檢查網路
        updateStep('step1', '步驟 1: ✅ 網路連線正常', 'success');

        // 步驟 2: API 載入檢查
        let apiLoadTimeout = setTimeout(() => {
            updateStep('step2', '步驟 2: ❌ API 載入超時 (30秒)', 'error');
            updateStep('step3', '步驟 3: ❌ 無法進行測試', 'error');

            showError(`
                <div class="status error">
                    <strong>API 載入失敗的可能原因：</strong>
                    <ul>
                        <li>API 金鑰無效或設定錯誤</li>
                        <li>未啟用 Maps JavaScript API</li>
                        <li>HTTP 引薦者限制設定問題</li>
                        <li>網路連線問題</li>
                        <li>配額已用完</li>
                    </ul>
                </div>

                <h4>🔧 立即修復步驟：</h4>
                <ol>
                    <li>前往 <a href="https://console.cloud.google.com/apis/library/maps-backend.googleapis.com" target="_blank">Google Cloud Console</a></li>
                    <li>確認 Maps JavaScript API 已啟用</li>
                    <li>檢查 API 金鑰的 HTTP 引薦者設定</li>
                    <li>加入以下域名限制：
                        <pre>http://localhost:8000/*
http://127.0.0.1:8000/*
localhost:8000/*
127.0.0.1:8000/*</pre>
                    </li>
                </ol>
            `);
        }, 30000); // 30秒超時

        // Google Maps API 載入成功回調
        function initTestMap() {
            clearTimeout(apiLoadTimeout);

            updateStep('step2', '步驟 2: ✅ Google Maps API 載入成功', 'success');

            try {
                // 步驟 3: 測試地圖創建
                const map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 10,
                    center: { lat: 25.0330, lng: 121.5654 }, // 台北101
                });

                // 添加標記
                new google.maps.Marker({
                    position: { lat: 25.0330, lng: 121.5654 },
                    map: map,
                    title: '測試成功！這裡是台北101'
                });

                updateStep('step3', '步驟 3: ✅ 地圖初始化成功', 'success');
                showSuccess();

                const loadTime = Date.now() - testStartTime;
                console.log(`✅ Google Maps API 測試成功，載入時間: ${loadTime}ms`);

            } catch (error) {
                updateStep('step3', `步驟 3: ❌ 地圖初始化失敗`, 'error');
                showError(`
                    <div class="status error">
                        <strong>地圖初始化錯誤:</strong><br>
                        ${error.message}
                    </div>
                `);
                console.error('地圖初始化錯誤:', error);
            }
        }

        // 處理 API 認證失敗
        function handleAuthFailure() {
            clearTimeout(apiLoadTimeout);
            updateStep('step2', '步驟 2: ❌ API 認證失敗', 'error');
            updateStep('step3', '步驟 3: ❌ 無法進行測試', 'error');

            showError(`
                <div class="status error">
                    <strong>認證失敗！</strong> 這是最常見的問題。
                </div>

                <h4>🔧 修復步驟：</h4>
                <ol>
                    <li><strong>檢查 API 金鑰</strong>: 確認複製正確</li>
                    <li><strong>啟用 API</strong>: 在 Google Cloud Console 中啟用 "Maps JavaScript API"</li>
                    <li><strong>設定域名限制</strong>:
                        <ul>
                            <li>前往 <a href="https://console.cloud.google.com/apis/credentials" target="_blank">憑證頁面</a></li>
                            <li>點擊你的 API 金鑰</li>
                            <li>選擇 "HTTP 引薦者 (網站)"</li>
                            <li>加入: <code>http://localhost:8000/*</code></li>
                        </ul>
                    </li>
                </ol>
            `);
        }

        // 全域錯誤處理
        window.gm_authFailure = handleAuthFailure;
        window.initTestMap = initTestMap;

        console.log('開始 Google Maps API 測試...');
    </script>

    <!-- Google Maps API 載入 -->
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkb3gNyldoHpt7IwyduZtXQ2Br1K0ooc0&callback=initTestMap"
            onerror="handleAuthFailure()">
    </script>
</body>
</html>
